apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-secret-prod
  namespace: prod
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: postgres-secret-prod
  data:
  - secretKey: POSTGRES_USER
    remoteRef:
      key: secret/family-heritage/prod
      property: POSTGRES_USER
  - secretKey: POSTGRES_DB
    remoteRef:
      key: secret/family-heritage/prod
      property: POSTGRES_DB
  - secretKey: POSTGRES_PASSWORD
    remoteRef:
      key: secret/family-heritage/prod
      property: POSTGRES_PASSWORD
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-secret-prod
  namespace: prod
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: backend-secret-prod
  data:
  - secretKey: APP_JWT_SECRET
    remoteRef:
      key: secret/family-heritage/prod
      property: APP_JWT_SECRET
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ghcr-secret
  namespace: prod
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: ghcr-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: >-
          {"auths":{"ghcr.io":{"username":"{{ .username | toString }}","password":"{{ .password | toString }}","auth":"{{ printf "%s:%s" .username .password | b64enc }}"}}}
  dataFrom:
    - extract:
        key: secret/ghcr